# IPC Module

## Overview
This module is responsible for receiving sensor data from the MCU and storing it in an SQLite3 database.
The data is transmitted from the MCU every 50 milliseconds in a CSV format with the following columns:

1. Elapsed Time (ms)
2. Ax (g)
3. Ay (g)
4. Az (g)
5. Gx (dps)
6. Gy (dps)
7. Gz (dps)
8. Temperature (°C)
9. Engine Speed (rpm)
10. Vehicle Speed (km/h)
11. Engine Load (%)
12. Throttle Position (%)
13. MIL Distance (km)
14. O2 Sensor #1 Voltage (V)
15. O2 Sensor #2 Voltage (V)
16. O2 Sensor #1 Current (mA)
17. O2 Sensor #2 Current (mA)

## Setup
There exists a `setup.sh` that configures the required paths for the module to run.
There also exists a `start.sh` that will start the module.
Both scripts make usage of the commands described below.

## Schema
Three separate tables are used in the database to organize the sensor data and machine-learning results:

> Note: The module computes the approximate sample timestamp (timestamp from sampling on the MCU) by subtracting the elapsed time from the reception timestamp (timestamp from receiving over IPC). This occurs before being written to the database.

### IMU Table (`IMU_DATA`)
| Column          | Type   | Description                              |
|-----------------|--------|------------------------------------------|
| `time`          | `TEXT` | Timestamp of the measurement             |
| `ax`            | `REAL` | Acceleration in X-axis (g)               |
| `ay`            | `REAL` | Acceleration in Y-axis (g)               |
| `az`            | `REAL` | Acceleration in Z-axis (g)               |
| `gx`            | `REAL` | Angular velocity in X-axis (dps)         |
| `gy`            | `REAL` | Angular velocity in Y-axis (dps)         |
| `gz`            | `REAL` | Angular velocity in Z-axis (dps)         |
| `temp`          | `REAL` | Temperature (°C)                         |

### OBD Table (`OBD_DATA`)

| Column          | Type   | Description                              |
|-----------------|--------|------------------------------------------|
| `time`          | `TEXT` | Timestamp of the measurement             |
| `engine_speed`  | `REAL` | Engine speed (rpm)                       |
| `vehicle_speed` | `REAL` | Vehicle speed (km/h)                     |
| `engine_load`   | `REAL` | Engine load (%)                          |
| `throttle_pos`  | `REAL` | Throttle position (%)                    |
| `mil_distance`  | `REAL` | Distance since MIL activated (km)        |
| `o2_sens1_volt` | `REAL` | O2 Sensor #1 voltage (V)                 |
| `o2_sens2_volt` | `REAL` | O2 Sensor #2 voltage (V)                 |
| `o2_sens1_curr` | `REAL` | O2 Sensor #1 current (mA)                |
| `o2_sens2_curr` | `REAL` | O2 Sensor #2 current (mA)                |

### ML Table (`ML_DATA`)

| Column          | Type   | Description                              |
|-----------------|--------|------------------------------------------|

## Commands
The module is accessible through `main.py` and utilizes `database.py` and `ipc.py` as support scripts.
The main script provides several commands for setting up and managing the IPC system.

***IMPORTANT***: The firmware binary, firmware control script, and database paths must be configured *BEFORE* the usage of `start`, `stop`, or `state` commands.

The general usage is as follows:
```bash
python main.py [command] [arguments...]
```

### `firmware <path>`
Sets the path to the compiled firmware binary generated by STM32CubeIDE.
```bash
python main.py firmware path/to/firmware.elf
```

### `script <path>`
Sets the path to the firmware control script generated by STM32CubeIDE.
```bash
python main.py script path/to/script.sh
```

### `database <path>`
Sets the path to the desired SQLite database (`.db`) file location.
```bash
python main.py database path/to/database.db
```

### `state`
Displays whether the firmware is online or offline.

### `start <port>`
Starts the firmware and IPC listener on the given serial port.
```bash
python main.py start /dev/ttyUSB0
```

### `stop`
Stops the firmware.
```bash
python main.py stop
```
